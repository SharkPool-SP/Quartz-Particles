import*as e from"https://cdn.jsdelivr.net/npm/twgl.js@4/dist/4.x/twgl-full.module.min.js";let radianConvert=Math.PI/180,vertices=[-.5,-.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,-.5,.5,],texcoords=[0,0,1,0,0,1,1,0,1,1,0,1],TWO_PI=2*Math.PI,INV_TWO_PI=8192/TWO_PI,sinTable=new Float32Array(8192),cosTable=new Float32Array(8192);for(let i=0;i<8192;i++){let t=i/8192*TWO_PI;sinTable[i]=Math.sin(t),cosTable[i]=Math.cos(t)}let engineVertShader=`attribute vec2 a_position,a_texcoord;uniform mat4 u_matrix;varying vec2 v_texcoord;void main(){gl_Position=u_matrix*vec4(a_position,0,1);v_texcoord=a_texcoord;}`,engineFragShader=`precision mediump float;uniform sampler2D u_texture;uniform vec4 u_tintColor;varying vec2 v_texcoord;void main(){gl_FragColor=texture2D(u_texture,v_texcoord)*u_tintColor;}`,backupURL="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48cGF0aCBkPSJNMCA1MFYwaDUwdjUweiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==",defaultSettings={maxP:{val:50,inf:0},emission:{val:1,inf:0},time:{val:.4,inf:.1},speed:{val:15,inf:0},xPos:{val:10,inf:0},yPos:{val:0,inf:0},gravX:{val:0,inf:0},gravY:{val:-1.5,inf:0},sDir:{val:0,inf:25},eDir:{val:0,inf:0},sSpin:{val:0,inf:0},eSpin:{val:45,inf:135},sSize:{val:25,inf:10},eSize:{val:15,inf:5},sStreX:{val:100,inf:0},eStreX:{val:100,inf:0},sStreY:{val:100,inf:0},eStreY:{val:100,inf:0},accelRad:{val:0,inf:0},accelTan:{val:0,inf:0},sinW:{val:0,inf:0},cosW:{val:0,inf:0},sinS:{val:1,inf:0},cosS:{val:1,inf:0},fIn:{val:0,inf:5},fOut:{val:15,inf:2},sCol:{val:[255,0,255],inf:0},eCol:{val:[0,0,255],inf:0}},defaultScale={width:480,height:360},fastSin=e=>sinTable[8191&Math.floor(e*INV_TWO_PI)],fastCos=e=>cosTable[8191&Math.floor(e*INV_TWO_PI)],rng=(e,t)=>e+(2*Math.random()-1)*t,clamp=(e,t,r)=>r>t?t:e>r?e:r,image2Texture=(t,r,n)=>{let a=new Image;a.crossOrigin="Anonymous",a.src=t,a.onerror=e=>console.error("Error loading texture:",e),a.onload=()=>n({tWidth:a.width,tHeight:a.height,texture:e.createTexture(r,{src:a,flipY:!0})})},shiftRGB=e=>e.val.map(t=>clamp(0,255,rng(t,e.inf))),createTint=(e,t,r)=>t.map((t,n)=>(t*r+e[n]*(1-r))/255);class QuartzParticles{constructor(){this.engine=null,this.emitters=null}initialize(t=defaultScale){let r=document.createElement("canvas"),n=r.getContext("webgl2")??r.getContext("webgl");r.width=t.width,r.height=t.height;let a=e.m4.ortho(0,r.width,r.height,0,-1,1),l=e.createProgramInfo(n,[engineVertShader,engineFragShader,]),s=e.createBufferInfoFromArrays(n,{a_position:{numComponents:2,data:vertices},a_texcoord:{numComponents:2,data:texcoords}});n.useProgram(l.program),e.setBuffersAndAttributes(n,l,s),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),this.engine={canvas:r,gl:n,programInfo:l,bufferInfo:s,projection:a,interpolate:!1,noTrails:!0},this.emitters=new Map}disposeEngine(){this.emitters.forEach(e=>{e.textureData?.texture&&this.engine.gl.deleteTexture(e.textureData.texture)}),this.engine.canvas.remove(),this.engine=null,this.emitters.clear()}resetEngineFlow(){this.emitters.forEach(e=>{e.frameCnt=0,e.tintCache=new Map})}updateEngine(t=1){let{canvas:r,gl:n,programInfo:a,bufferInfo:l,projection:s,data:o,interpolate:$,noTrails:f}=this.engine,c=this.emitters,{width:v,height:g}=r,u=$?1+t:1,m=.01*u;e.bindFramebufferInfo(n,null),n.viewport(0,0,v,g),f&&(n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT)),c.forEach(t=>{if(!t.textureData)return;let{pos:r,opts:o,tintCache:$,textureData:f}=t,{tWidth:c,tHeight:d}=f;t.frameCnt++;let _=Math.round(rng(o.maxP.val,o.maxP.inf)),x=[r[0]-.25*c,r[1]+.25*d],S=t.data;if(t.frameCnt>1&&S.size<_){let h=Math.round(rng(o.emission.val,o.emission.inf)),p=_>h?h:_;for(let I=0;I<p;I++){let C=rng(o.time.val,o.time.inf),P={ind:0,conLife:100*C,life:C,speed:rng(o.speed.val,o.speed.inf),x:x[0]+rng(o.xPos.val,o.xPos.inf),y:x[1]+rng(-1*o.yPos.val,o.yPos.inf),dir:rng(o.sDir.val-90,o.sDir.inf),eDir:rng(o.eDir.val-90,o.eDir.inf),spin:rng(o.sSpin.val-90,o.sSpin.inf),eSpin:rng(o.eSpin.val-90,o.eSpin.inf),size:.01*rng(o.sSize.val,o.sSize.inf),eSize:.01*rng(o.eSize.val,o.eSize.inf),streX:.01*rng(o.sStreX.val,o.sStreX.inf),eStreX:.01*rng(o.eStreX.val,o.eStreX.inf),streY:.01*rng(o.sStreY.val,o.sStreY.inf),eStreY:.01*rng(o.eStreY.val,o.eStreY.inf),gravX:rng(o.gravX.val,o.gravX.inf),gravY:rng(o.gravY.val,o.gravY.inf),accelRad:rng(o.accelRad.val,o.accelRad.inf),accelTan:rng(o.accelTan.val,o.accelTan.inf),sinW:rng(o.sinW.val,o.sinW.inf),cosW:rng(o.cosW.val,o.cosW.inf),sinS:rng(o.sinS.val,o.sinS.inf),cosS:rng(o.cosS.val,o.cosS.inf),fIn:rng(o.fIn.val,o.fIn.inf),fOut:rng(o.fOut.val,o.fOut.inf),sCol:shiftRGB(o.sCol),eCol:shiftRGB(o.eCol),ogPos:[]};P.ogPos=[P.x,P.y],S.add(P)}}for(let w of(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,f.texture),S)){let{ind:T,conLife:D,life:b,x:y,y:W,ogPos:z,dir:E,eDir:R,size:M,eSize:Y,spin:A,eSpin:X,speed:Z,gravX:F,gravY:O,streX:U,eStreX:B,streY:H,eStreY:j,accelRad:N,accelTan:L,sinW:G,sinS:V,cosW:J,cosS:Q,fIn:k,fOut:q,sCol:K,eCol:ee}=w;if(w.life-m<=0){S.delete(w);return}let et=y-(r[0]+.5*v),ei=W-(r[1]+.5*g),er=Math.hypot(et,ei)||1,en=et/er,ea=ei/er,el=E*radianConvert;z[0]+=(fastCos(el)*Z+en*N*T+-ea*L*T)*u,z[0]-=F*T*u,z[1]+=(fastSin(el)*Z+ea*N*T+en*L*T)*u,z[1]-=O*T*u;let es=D-b;w.x=z[0]+fastSin(es*V)*G*u,w.y=z[1]+fastCos(es*Q)*J*u;let eo=T*(1/k),e$=(D-T)*(1/q),ef=clamp(0,1,Math.min(eo,e$)),ec=b.toFixed(4),ev=$.get(ec);ev||(ev=createTint(K,ee,clamp(0,1,T/D)),$.set(ec,ev)),w.ind++,w.life-=m;let eg=w.x+.5*v,eu=w.y+.5*g,em=c*M*U,ed=d*M*H;if(eg+em<0||eg-em>v||eu+ed<0||eu-ed>g)return;let e_=[w.x+.5*v,w.y+.5*g,0],ex=e.m4.translate(s,e_);ex=e.m4.rotateZ(ex,A*radianConvert),ex=e.m4.scale(ex,[em,ed,1]),e.setUniforms(a,{u_matrix:ex,u_texture:f.texture,u_tintColor:[...ev,ef]}),e.drawBufferInfo(n,l);let eS=u/D;w.dir+=(R-E)*eS,w.spin+=(X-A)*eS,w.size+=(Y-M)*eS,w.streX+=(B-U)*eS,w.streY+=(j-H)*eS}})}createEmitter(e,t=[0,0],r,n){let a={pos:t,opts:n??structuredClone(defaultSettings),textureData:null,frameCnt:0,data:new Set,tintCache:new Map};if("object"!=typeof r||Array.isArray(r))image2Texture(r||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48cGF0aCBkPSJNMCA1MFYwaDUwdjUweiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==",this.engine.gl,e=>{a.textureData=e});else{if(!(r.texture instanceof WebGLTexture)){console.error(`QuartzParticles.createEmitter -- (${e}) missing WebGLTexture 'texture' property!`);return}if("number"==typeof r.tWidth&&"number"==typeof r.tHeight)a.textureData=r;else{console.error(`QuartzParticles.createEmitter -- (${e}) missing 'tWidth', 'tHeight' number properties!`);return}}this.emitters.set(e,a)}disposeEmitter(e){let t=this.emitters.get(e);t&&(t.textureData?.texture&&this.engine.gl.deleteTexture(t.textureData.texture),this.emitters.delete(e))}}export default QuartzParticles;
