import*as e from"https://cdn.jsdelivr.net/npm/twgl.js@4/dist/4.x/twgl-full.module.min.js";let radianConvert=Math.PI/180,vertices=[-.5,-.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,-.5,.5,],texcoords=[0,0,1,0,0,1,1,0,1,1,0,1],TWO_PI=2*Math.PI,INV_TWO_PI=8192/TWO_PI,sinTable=new Float32Array(8192),cosTable=new Float32Array(8192);for(let i=0;i<8192;i++){let t=i/8192*TWO_PI;sinTable[i]=Math.sin(t),cosTable[i]=Math.cos(t)}let engineVertShader=`attribute vec2 a_position;attribute vec2 a_texcoord;uniform mat4 u_matrix;varying vec2 v_texcoord;void main(){gl_Position=u_matrix*vec4(a_position,0,1);v_texcoord=a_texcoord;}`,engineFragShader=`precision mediump float;uniform sampler2D u_texture;uniform vec4 u_tintColor;varying vec2 v_texcoord;void main(){vec4 tex=texture2D(u_texture, v_texcoord);gl_FragColor=tex*u_tintColor;}`,backupURL="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48cGF0aCBkPSJNMCA1MFYwaDUwdjUweiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==",defaultSettings={maxP:{val:50,inf:0},emission:{val:1,inf:0},time:{val:.4,inf:.1},speed:{val:15,inf:0},xPos:{val:10,inf:0},yPos:{val:0,inf:0},gravX:{val:0,inf:0},gravY:{val:-1.5,inf:0},sDir:{val:0,inf:25},eDir:{val:0,inf:0},sSpin:{val:0,inf:0},eSpin:{val:45,inf:135},sSize:{val:25,inf:10},eSize:{val:15,inf:5},sStreX:{val:100,inf:0},eStreX:{val:100,inf:0},sStreY:{val:100,inf:0},eStreY:{val:100,inf:0},accelRad:{val:0,inf:0},accelTan:{val:0,inf:0},sinW:{val:0,inf:0},cosW:{val:0,inf:0},sinS:{val:1,inf:0},cosS:{val:1,inf:0},fIn:{val:0,inf:5},fOut:{val:15,inf:2},sCol:{val:[255,0,255],inf:0},eCol:{val:[0,0,255],inf:0}},defaultScale={width:480,height:360},fastSin=e=>sinTable[8191&Math.floor(e*INV_TWO_PI)],fastCos=e=>cosTable[8191&Math.floor(e*INV_TWO_PI)],rng=(e,t)=>e+(2*Math.random()-1)*t,clamp=(e,t,n)=>n>t?t:e>n?e:n,image2Texture=(t,n,r)=>{let a=new Image;a.crossOrigin="Anonymous",a.src=t,a.onerror=e=>console.error("Error loading texture:",e),a.onload=()=>r({tWidth:a.width,tHeight:a.height,texture:e.createTexture(n,{src:a,flipY:!0})})},shiftRGB=e=>e.val.map(t=>clamp(0,255,rng(t,e.inf))),createTint=(e,t,n)=>t.map((t,r)=>(t*n+e[r]*(1-n))/255);class QuartzParticles{constructor(){this.engine=null,this.emitters=null}initialize(t=defaultScale){let n=document.createElement("canvas"),r=n.getContext("webgl2")??n.getContext("webgl");n.width=t.width,n.height=t.height;let a=e.m4.ortho(0,n.width,n.height,0,-1,1),l=e.createProgramInfo(r,[engineVertShader,engineFragShader,]),s=e.createBufferInfoFromArrays(r,{a_position:{numComponents:2,data:vertices},a_texcoord:{numComponents:2,data:texcoords}});r.useProgram(l.program),e.setBuffersAndAttributes(r,l,s),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),this.engine={canvas:n,gl:r,programInfo:l,bufferInfo:s,projection:a,interpolate:!1,noTrails:!0},this.emitters=new Map}disposeEngine(){this.emitters.forEach(e=>{e.textureData?.texture&&this.engine.gl.deleteTexture(e.textureData.texture)}),this.engine.canvas.remove(),this.engine=null,this.emitters.clear()}resetEngineFlow(){this.emitters.forEach(e=>{e.frameCnt=0,e.tintCache=new Map})}updateEngine(t=1){let{canvas:n,gl:r,programInfo:a,bufferInfo:l,projection:s,data:o,interpolate:$,noTrails:f}=this.engine,c=this.emitters,{width:v,height:g}=n,u=.01*t;e.bindFramebufferInfo(r,null),r.viewport(0,0,v,g),f&&(r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT)),c.forEach(n=>{if(!n.textureData)return;let{pos:o,opts:$,data:f,tintCache:c,textureData:m}=n,{tWidth:d,tHeight:_}=m;n.frameCnt++;let x=Math.round(rng($.maxP.val,$.maxP.inf)),S=[o[0]-.25*d,o[1]+.25*_];if(n.frameCnt>1&&f.size<x){let h=Math.round(rng($.emission.val,$.emission.inf)),p=x>h?h:x;for(let I=0;I<p;I++){let C=rng($.time.val,$.time.inf),P={ind:0,conLife:100*C,life:C,speed:rng($.speed.val,$.speed.inf),x:S[0]+rng($.xPos.val,$.xPos.inf),y:S[1]+rng(-1*$.yPos.val,$.yPos.inf),dir:rng($.sDir.val-90,$.sDir.inf),eDir:rng($.eDir.val-90,$.eDir.inf),spin:rng($.sSpin.val-90,$.sSpin.inf),eSpin:rng($.eSpin.val-90,$.eSpin.inf),size:.01*rng($.sSize.val,$.sSize.inf),eSize:.01*rng($.eSize.val,$.eSize.inf),streX:.01*rng($.sStreX.val,$.sStreX.inf),eStreX:.01*rng($.eStreX.val,$.eStreX.inf),streY:.01*rng($.sStreY.val,$.sStreY.inf),eStreY:.01*rng($.eStreY.val,$.eStreY.inf),gravX:rng($.gravX.val,$.gravX.inf),gravY:rng($.gravY.val,$.gravY.inf),accelRad:rng($.accelRad.val,$.accelRad.inf),accelTan:rng($.accelTan.val,$.accelTan.inf),sinW:rng($.sinW.val,$.sinW.inf),cosW:rng($.cosW.val,$.cosW.inf),sinS:rng($.sinS.val,$.sinS.inf),cosS:rng($.cosS.val,$.cosS.inf),fIn:rng($.fIn.val,$.fIn.inf),fOut:rng($.fOut.val,$.fOut.inf),sCol:shiftRGB($.sCol),eCol:shiftRGB($.eCol),ogPos:[]};P.ogPos=[P.x,P.y],f.add(P)}}for(let w of(r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,m.texture),f)){let{ind:T,conLife:D,life:b,x:y,y:W,ogPos:z,dir:E,eDir:R,size:M,eSize:Y,spin:A,eSpin:X,speed:Z,gravX:F,gravY:O,streX:U,eStreX:B,streY:H,eStreY:j,accelRad:N,accelTan:L,sinW:G,sinS:V,cosW:J,cosS:Q,fIn:k,fOut:q,sCol:K,eCol:ee}=w;if(w.life-u<=0){f.delete(w);continue}let et=y-(o[0]+.5*v),ei=W-(o[1]+.5*g),en=Math.hypot(et,ei)||1,er=et/en,ea=ei/en,el=E*radianConvert;z[0]+=(fastCos(el)*Z+er*N*T+-ea*L*T)*t,z[0]-=F*T*t,z[1]+=(fastSin(el)*Z+ea*N*T+er*L*T)*t,z[1]-=O*T*t;let es=D-b;w.x=z[0]+fastSin(es*V)*G,w.y=z[1]+fastCos(es*Q)*J;let eo=T*(1/k),e$=(D-T)*(1/q),ef=clamp(0,1,Math.min(eo,e$)),ec=b.toFixed(4),ev=c.get(ec);ev||(ev=createTint(K,ee,clamp(0,1,T/D)),c.set(ec,ev)),w.ind+=t,w.life-=u;let eg=w.x+.5*v,eu=w.y+.5*g,em=d*M*U,ed=_*M*H;if(eg+em<0||eg-em>v||eu+ed<0||eu-ed>g)continue;let e_=[w.x+.5*v,w.y+.5*g,0],ex=e.m4.translate(s,e_);ex=e.m4.rotateZ(ex,A*radianConvert),ex=e.m4.scale(ex,[em,ed,1]),e.setUniforms(a,{u_matrix:ex,u_texture:m.texture,u_tintColor:[...ev,ef]}),e.drawBufferInfo(r,l);let eS=t/D;w.dir+=(R-E)*eS,w.spin+=(X-A)*eS,w.size+=(Y-M)*eS,w.streX+=(B-U)*eS,w.streY+=(j-H)*eS}})}createEmitter(e,t=[0,0],n,r){let a={pos:t,opts:r??structuredClone(defaultSettings),textureData:null,frameCnt:0,data:new Set,tintCache:new Map};if("object"!=typeof n||Array.isArray(n))image2Texture(n||"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgdmlld0JveD0iMCAwIDUwIDUwIj48cGF0aCBkPSJNMCA1MFYwaDUwdjUweiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==",this.engine.gl,e=>{a.textureData=e});else{if(!(n.texture instanceof WebGLTexture)){console.error(`QuartzParticles.createEmitter -- (${e}) missing WebGLTexture 'texture' property!`);return}if("number"==typeof n.tWidth&&"number"==typeof n.tHeight)a.textureData=n;else{console.error(`QuartzParticles.createEmitter -- (${e}) missing 'tWidth', 'tHeight' number properties!`);return}}this.emitters.set(e,a)}disposeEmitter(e){let t=this.emitters.get(e);t&&(t.textureData?.texture&&this.engine.gl.deleteTexture(t.textureData.texture),this.emitters.delete(e))}}export default QuartzParticles;
